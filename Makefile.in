# Makefile for Kyoto Tycoon



#================================================================
# Setting Variables
#================================================================


# Generic settings
SHELL = @SHELL@

# Package information
PACKAGE = @PACKAGE_NAME@
VERSION = @PACKAGE_VERSION@
PACKAGEDIR = $(PACKAGE)-$(VERSION)
PACKAGETGZ = $(PACKAGE)-$(VERSION).tar.gz
LIBVER = @MYLIBVER@
LIBREV = @MYLIBREV@

# Targets
HEADERFILES = @MYHEADERFILES@
LIBRARYFILES = @MYLIBRARYFILES@
LIBOBJFILES = @MYLIBOBJFILES@
COMMANDFILES = @MYCOMMANDFILES@
MAN1FILES = @MYMAN1FILES@
DOCUMENTFILES = @MYDOCUMENTFILES@
PCFILES = @MYPCFILES@

# Install destinations
prefix = @prefix@
exec_prefix = @exec_prefix@
datarootdir = @datarootdir@
INCLUDEDIR = @includedir@
LIBDIR = @libdir@
BINDIR = @bindir@
LIBEXECDIR = @libexecdir@
DATADIR = @datadir@/$(PACKAGE)
MAN1DIR = @mandir@/man1
PCDIR = @libdir@/pkgconfig
DESTDIR =

# Building configuration
CC = @CC@
CXX = @CXX@
CPPFLAGS = @MYCPPFLAGS@ \
  -D_KT_PREFIX="\"$(prefix)\"" -D_KT_INCLUDEDIR="\"$(INCLUDEDIR)\"" \
  -D_KT_LIBDIR="\"$(LIBDIR)\"" -D_KT_BINDIR="\"$(BINDIR)\"" -D_KT_LIBEXECDIR="\"$(LIBEXECDIR)\"" \
  -D_KT_APPINC="\"-I$(INCLUDEDIR)\"" -D_KT_APPLIBS="\"-L$(LIBDIR) -lkyototycoon @LIBS@\""
CFLAGS = @MYCFLAGS@
CXXFLAGS = @MYCXXFLAGS@
LDFLAGS = @MYLDFLAGS@
CMDLDFLAGS = @MYCMDLDFLAGS@
LIBS = @LIBS@
LDENV = LD_RUN_PATH=/lib:/usr/lib:$(LIBDIR):$(HOME)/lib:/usr/local/lib:@MYRUNPATH@
RUNENV = @MYLDLIBPATHENV@=.:/lib:/usr/lib:$(LIBDIR):$(HOME)/lib:/usr/local/lib:@MYRUNPATH@
POSTCMD = @MYPOSTCMD@



#================================================================
# Suffix rules
#================================================================


.SUFFIXES :
.SUFFIXES : .c .cc .o

.c.o :
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $<

.cc.o :
	$(CXX) -c $(CPPFLAGS) $(CXXFLAGS) $<



#================================================================
# Actions
#================================================================


all : $(LIBRARYFILES) $(COMMANDFILES)
	@$(POSTCMD)
	@printf '\n'
	@printf '#================================================================\n'
	@printf '# Ready to install.\n'
	@printf '#================================================================\n'


clean :
	rm -rf $(LIBRARYFILES) $(LIBOBJFILES) $(COMMANDFILES) $(CGIFILES) \
	  *.o *.gch a.out check.in check.out gmon.out *.log *.vlog words.tsv \
	  casket* *.kch *.kct *.kcd *.kcf *.wal *.tmpkc* *.kcss *~ hoge moge tako ika


version :
	sed -e 's/_KT_VERSION.*/_KT_VERSION    "$(VERSION)"/' \
	  -e "s/_KT_LIBVER.*/_KT_LIBVER     $(LIBVER)/" \
	  -e "s/_KT_LIBREV.*/_KT_LIBREV     $(LIBREV)/" myconf.h > myconf.h~
	[ -f myconf.h~ ] && mv -f myconf.h~ myconf.h


untabify :
	ls *.cc *.h *.idl | while read name ; \
	  do \
	    sed -e 's/\t/        /g' -e 's/ *$$//' $$name > $$name~; \
	    [ -f $$name~ ] && mv -f $$name~ $$name ; \
	  done


install :
	mkdir -p $(DESTDIR)$(INCLUDEDIR)
	cp -Rf $(HEADERFILES) $(DESTDIR)$(INCLUDEDIR)
	mkdir -p $(DESTDIR)$(LIBDIR)
	cp -Rf $(LIBRARYFILES) $(DESTDIR)$(LIBDIR)
	mkdir -p $(DESTDIR)$(BINDIR)
	cp -Rf $(COMMANDFILES) $(DESTDIR)$(BINDIR)
	mkdir -p $(DESTDIR)$(DATADIR)
	cp -Rf $(DOCUMENTFILES) $(DESTDIR)$(DATADIR)
	mkdir -p $(DESTDIR)$(MAN1DIR)
	cd man && cp -Rf $(MAN1FILES) $(DESTDIR)$(MAN1DIR)
	mkdir -p $(DESTDIR)$(PCDIR)
	cp -Rf $(PCFILES) $(DESTDIR)$(PCDIR)
	-[ "$$UID" = 0 ] && PATH=/sbin:/usr/sbin:$(PATH) ldconfig 2>/dev/null || true
	@printf '\n'
	@printf '#================================================================\n'
	@printf '# Thanks for using Kyoto Tycoon.\n'
	@printf '#================================================================\n'


install-strip :
	$(MAKE) DESTDIR=$(DESTDIR) install
	cd $(DESTDIR)$(BINDIR) && strip $(COMMANDFILES)


uninstall :
	-cd $(DESTDIR)$(INCLUDEDIR) && rm -f $(HEADERFILES)
	-cd $(DESTDIR)$(LIBDIR) && rm -f $(LIBRARYFILES)
	-cd $(DESTDIR)$(BINDIR) && rm -f $(COMMANDFILES)
	-cd $(DESTDIR)$(MAN1DIR) && rm -f $(MAN1FILES)
	-rm -rf $(DESTDIR)$(DATADIR)
	-cd $(DESTDIR)$(PCDIR) && rm -f $(PCFILES)
	-[ "$$UID" = 0 ] && PATH=/sbin:/usr/sbin:$(PATH) ldconfig 2>/dev/null || true


dist :
	$(MAKE) version
	$(MAKE) untabify
	$(MAKE) distclean
	cd .. && tar cvf - $(PACKAGEDIR) | gzip -c > $(PACKAGETGZ)
	sync ; sync


distclean : clean
	cd example && $(MAKE) clean
	rm -rf Makefile kyototycoon.pc config.cache config.log config.status autom4te.cache
	which ccache >/dev/null 2>&1 && ccache -C >/dev/null 2>&1


check :
	$(MAKE) check-util
	$(MAKE) check-timed
	rm -rf casket*
	@printf '\n'
	@printf '#================================================================\n'
	@printf '# Checking completed.\n'
	@printf '#================================================================\n'


check-util :
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./ktutilmgr date -ds '1978-02-11T18:05:00+09:00' -wf
	$(RUNENV) $(RUNCMD) ./ktutilmgr date -ds '1977-10-07T12:00:00+09:00' -rf


check-timed :
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedmgr create -otr "casket.kch#apow=1#fpow=2#bnum=3"
	$(RUNENV) $(RUNCMD) ./kttimedmgr inform -st casket.kch
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -add -xt 3600 casket.kch duffy 1231
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -add -xt 3600 casket.kch micky 0101
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch fal 1007
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch mikio 0211
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch natsuki 0810
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch micky ""
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -app -xt 3600 casket.kch duffy kukuku
	$(RUNENV) $(RUNCMD) ./kttimedmgr remove casket.kch micky
	$(RUNENV) $(RUNCMD) ./kttimedmgr list -pv -pt casket.kch > check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr copy casket.kch casket-para
	$(RUNENV) $(RUNCMD) ./kttimedmgr dump casket.kch check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr load -otr casket.kch check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt -987654321 casket.kch ryu 1
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt -987654321 casket.kch ken 2
	$(RUNENV) $(RUNCMD) ./kttimedmgr remove casket.kch duffy
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch ryu syo-ryu-ken
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -xt 3600 casket.kch ken tatsumaki-senpu-kyaku
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -inci -xt 3600 casket.kch int 1234
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -inci -xt 3600 casket.kch int 5678
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -incd -xt 3600 casket.kch double 1234.5678
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -incd -xt 3600 casket.kch double 8765.4321
	$(RUNENV) $(RUNCMD) ./kttimedmgr get -pt "casket.kch" mikio
	$(RUNENV) $(RUNCMD) ./kttimedmgr get -pt "casket.kch" ryu
	$(RUNENV) $(RUNCMD) ./kttimedmgr import casket.kch lab/numbers.tsv
	$(RUNENV) $(RUNCMD) ./kttimedmgr list -pv -pt -px "casket.kch#mode=r" > check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kch
	$(RUNENV) $(RUNCMD) ./kttimedmgr inform -st casket.kch
	$(RUNENV) $(RUNCMD) ./kttimedmgr create -otr -otl -onr \
	  "casket.kct#apow=1#fpow=3#opts=slc#bnum=1"
	$(RUNENV) $(RUNCMD) ./kttimedmgr import casket.kct < lab/numbers.tsv
	$(RUNENV) $(RUNCMD) ./kttimedmgr set casket.kct mikio kyotocabinet
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -app casket.kct tako ikaunini
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -app casket.kct mikio kyototyrant
	$(RUNENV) $(RUNCMD) ./kttimedmgr set -app casket.kct mikio kyotodystopia
	$(RUNENV) $(RUNCMD) ./kttimedmgr get -px casket.kct mikio > check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr list casket.kct > check.out
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest order -set "casket.kct#bnum=5000#msiz=50000" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -get "casket.kct#msiz=50000" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -getw "casket.kct#msiz=5000" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -rem "casket.kct#msiz=50000" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order "casket.kct#bnum=5000#msiz=50000" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -etc \
	  "casket.kct#bnum=5000#msiz=50000#dfunit=4" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -th 4 \
	  "casket.kct#bnum=5000#msiz=50000#dfunit=4" 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -th 4 -rnd -etc \
	  "casket.kct#bnum=5000#msiz=0#dfunit=1" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest order -th 4 -rnd -etc -tran \
	  "casket.kct#bnum=5000#msiz=0#dfunit=2" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest order -th 4 -rnd -etc -oat \
	  "casket.kct#bnum=5000#msiz=0#dfunit=3" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest order -th 4 -rnd -etc \
	  "casket.kct#apow=2#fpow=3#opts=slc#bnum=5000#msiz=0#dfunit=4" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest queue \
	  "casket.kct#bnum=5000#msiz=0" 10000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest queue -rnd \
	  "casket.kct#bnum=5000#msiz=0" 10000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest queue -th 4 -it 4 \
	  "casket.kct#bnum=5000#msiz=0" 10000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest queue -th 4 -it 4 -rnd \
	  "casket.kct#bnum=5000#msiz=0" 10000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest wicked "casket.kct#bnum=5000#msiz=0" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest wicked -th 4 -it 4 \
	  "casket.kct#bnum=5000#msiz=0#dfunit=1" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest wicked -th 4 -it 4 -oat \
	  "casket.kct#bnum=5000#msiz=0#dfunit=1" 1000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest wicked -th 4 -it 4 \
	  "casket.kct#apow=2#fpow=3#opts=slc#bnum=10000#msiz=0#dfunit=1" 10000
	$(RUNENV) $(RUNCMD) ./kttimedmgr check -onr casket.kct
	$(RUNENV) $(RUNCMD) ./kttimedtest tran casket.kct 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest tran -th 2 -it 4 casket.kct 10000
	$(RUNENV) $(RUNCMD) ./kttimedtest tran -th 2 -it 4 \
	  "casket.kct#apow=2#fpow=3#opts=slc#bnum=10000#msiz=0#dfunit=1" 1000
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest order -rnd "casket.kch#opts=s#bnum=256" 1000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -rnd "casket.kct#opts=l#psiz=256" 1000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -rnd "casket.kcd#opts=c#bnum=256" 1000
	$(RUNENV) $(RUNCMD) ./kttimedtest order -rnd "casket.kcf#opts=c#psiz=256" 1000
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest misc "casket#type=-"
	$(RUNENV) $(RUNCMD) ./kttimedtest misc "casket#type=+"
	$(RUNENV) $(RUNCMD) ./kttimedtest misc "casket#type=*#zcomp=def"
	$(RUNENV) $(RUNCMD) ./kttimedtest misc "casket#type=%#zcomp=gz"
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest misc \
	  "casket#type=kch#log=-#logkinds=debug#zcomp=lzocrc"
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest misc \
	  "casket#type=kct#log=-#logkinds=debug#zcomp=lzmacrc"
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest misc \
	  "casket#type=kcd#zcomp=arc#zkey=mikio"
	rm -rf casket*
	$(RUNENV) $(RUNCMD) ./kttimedtest misc \
	  "casket#type=kcf#zcomp=arc#zkey=mikio"


check-heavy :
	$(MAKE) check-timed-heavy


check-timed-heavy :
	$(RUNENV) ./kttimedtest order -th 1 -rnd -set 'casket.kch' 4000000
	$(RUNENV) ./kttimedtest order -th 4 -rnd -set 'casket.kch' 1000000
	$(RUNENV) ./kttimedtest order -th 4 -rnd -set 'casket.kch#dfunit=8' 1000000
	$(RUNENV) kcpolymgr check -onr 'casket.kch'
	$(RUNENV) ./kttimedtest order -th 1 -rnd -set 'casket.kct' 4000000
	$(RUNENV) ./kttimedtest order -th 4 -rnd -set 'casket.kct' 1000000
	$(RUNENV) ./kttimedtest order -th 4 -rnd -set 'casket.kct#dfunit=8' 1000000
	$(RUNENV) kcpolymgr check -onr 'casket.kct'


doc :
	$(MAKE) docclean
	mkdir -p doc/api
	doxygen


docclean :
	rm -rf doc/api


.PHONY : all clean install check doc



#================================================================
# Building binaries
#================================================================


libkyototycoon.a : $(LIBOBJFILES)
	$(AR) $(ARFLAGS) $@ $(LIBOBJFILES)


libkyototycoon.so.$(LIBVER).$(LIBREV).0 : $(LIBOBJFILES)
	if uname -a | egrep -i 'SunOS' > /dev/null ; \
	  then \
	    $(CXX) $(CXXFLAGS) -shared -Wl,-G,-h,libkyototycoon.so.$(LIBVER) -o $@ \
	      $(LIBOBJFILES) $(LDFLAGS) $(LIBS) ; \
	  else \
	    $(CXX) $(CXXFLAGS) -shared -Wl,-soname,libkyototycoon.so.$(LIBVER) -o $@ \
	      $(LIBOBJFILES) $(LDFLAGS) $(LIBS) ; \
	  fi


libkyototycoon.so.$(LIBVER) : libkyototycoon.so.$(LIBVER).$(LIBREV).0
	ln -f -s libkyototycoon.so.$(LIBVER).$(LIBREV).0 $@


libkyototycoon.so : libkyototycoon.so.$(LIBVER).$(LIBREV).0
	ln -f -s libkyototycoon.so.$(LIBVER).$(LIBREV).0 $@


libkyototycoon.$(LIBVER).$(LIBREV).0.dylib : $(LIBOBJFILES)
	$(CXX) $(CXXFLAGS) -dynamiclib -o $@ \
	  -install_name $(LIBDIR)/libkyototycoon.$(LIBVER).dylib \
	  -current_version $(LIBVER).$(LIBREV).0 -compatibility_version $(LIBVER) \
	  $(LIBOBJFILES) $(LDFLAGS) $(LIBS)


libkyototycoon.$(LIBVER).dylib : libkyototycoon.$(LIBVER).$(LIBREV).0.dylib
	ln -f -s libkyototycoon.$(LIBVER).$(LIBREV).0.dylib $@


libkyototycoon.dylib : libkyototycoon.$(LIBVER).$(LIBREV).0.dylib
	ln -f -s libkyototycoon.$(LIBVER).$(LIBREV).0.dylib $@


ktutiltest : ktutiltest.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktutilmgr : ktutilmgr.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktutilserv : ktutilserv.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


kttimedtest : kttimedtest.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


kttimedmgr : kttimedmgr.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktserver : ktserver.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktremotetest : ktremotetest.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktremotemgr : ktremotemgr.o $(LIBRARYFILES)
	$(LDENV) $(CXX) $(CXXFLAGS) -o $@ $< $(LDFLAGS) $(CMDLDFLAGS) -lkyototycoon $(LIBS)


ktutil.o : ktcommon.h ktutil.h myconf.h

ktsocket.o : ktcommon.h ktutil.h ktsocket.h myconf.h

ktthserv.o : ktcommon.h ktutil.h ktsocket.h ktthserv.h myconf.h

kthttp.o : ktcommon.h ktutil.h ktsocket.h ktthserv.h kthttp.h myconf.h

ktrpc.o : ktcommon.h ktutil.h ktsocket.h ktthserv.h kthttp.h ktrpc.h myconf.h

kttimeddb.o : ktcommon.h ktutil.h kttimeddb.h myconf.h

ktremotedb.o : ktcommon.h ktutil.h ktremotedb.h myconf.h

ktutiltest.o ktutilmgr.o ktutilserv.o kttimedtest.o kttimedmgr.o \
  ktserver.o ktremotetest.o ktremotemgr.o : \
  ktcommon.h ktutil.h ktsocket.h ktthserv.h kthttp.h ktrpc.h kttimeddb.h ktremotedb.h cmdcommon.h



# END OF FILE
